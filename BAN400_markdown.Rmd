---
title: "BAN400 markdown"
output: html_document
---

```{r setup, include=FALSE, message=FALSE}
library(tidyquant)
library(tidyverse)
library(dplyr)
library(corrplot)
library(nloptr)
library(gtools)
library(skimr)
library(svDialogs)
library(TTR)
library(RColorBrewer)

source("Ban400-Functions.R")
```



```{r }
risk_free_rate <- 0.02


tickers <- c("AAPL", "XOM", "BAC", "PFE", "NEE", "RTX", "GE", "REGN")
from_date <- "2019-01-01"
to_date <- "2020-05-01"


```





```{r}
tickers <- sample(stocks_with_industry$Symbol,)

input <- input_function(tickers, from_date, to_date)


plot_sectors(input[[1]])
plot_industries(input[[1]])


```







# input 1 = tickers
# input 2 = stock_prices
# input 3 = returns_matrix
# input 4 = stock_correlation
# input 5 = stock_return with date
# input 6 = stock_covariance
# input 7 = portfolio weigths
# input 8 = errors
# input 9 = stock info





```{r}
#finds the portfolio with the higest sharpe ratio
opt_sharpe <- stock_opt_sharpe(input[[1]],input[[7]],input[[3]],input[[6]])
opt_sharpe[[1]]

#finds the portfolio with the lowest yearly volatility
opt_vol <- stock_opt_vol(input[[1]],input[[7]],input[[3]],input[[6]])
opt_vol[[1]]

#find the portfolio with the higest sortino ratio
opt_sortino <- stock_opt_sortino(input[[1]],input[[7]],input[[3]],input[[6]])
opt_sortino[[1]]


#creates returns histogram
returns_hist(input[[5]])
#creates correlation matrix
correlation_plot(input[[4]])

# creates stock price history graph
stock_price_history(input[[2]])

#Creates effeciency frontier
efficency_frontier(input[[1]],input[[7]],input[[3]],input[[6]], n = 5000)



#plot optimal portfolio industry composition
portfolio_industry(input[[1]], opt_sharpe[[2]])


#tests the optimised portfolio vs the S&P500 index
from_date <- "2020-08-01"
to_date <- Sys.Date()

compare_SP500(as.matrix(opt_sharpe[[2]]),input[[1]],from_date,to_date)

```

```{r}


industies <- stock_info[stock_info$Symbol %in% input[[1]],]

stocks <- length(input[[1]])
stocks <- input[[1]]

plot_industries <- function(stocks) {
  industries <- stocks_with_industry[stocks_with_industry$Symbol %in% stocks,]
  mycolors <- colorRampPalette(brewer.pal(8, "Set2"))(length(stocks))
  
  industries %>% 
  group_by(Industry) %>%
  mutate(count = n()) %>%
  distinct(Industry, count) %>%
  ggplot(aes(x="", y = count, fill = Industry)) +
  geom_bar(stat="identity", width=1, color="white") +
  coord_polar("y", start=0) +
  theme_void() +  
  scale_fill_manual(values = mycolors) +
  
  geom_text(aes(label = paste0(round((count/sum(count))*100), "%")), position = position_stack(vjust = 0.5))
}

plot_sectors <- function(stocks) {
  industries <- stocks_with_industry[stocks_with_industry$Symbol %in% stocks,]
  mycolors <- colorRampPalette(brewer.pal(8, "Set2"))(length(stocks))
  
  industries %>% 
  group_by(Sector) %>%
  mutate(count = n()) %>%
  distinct(Sector, count) %>%
  ggplot(aes(x="", y = count, fill = Sector)) +
  geom_bar(stat="identity", width=1, color="white") +
  coord_polar("y", start=0) +
  theme_void() +  
  scale_fill_manual(values = mycolors) +
  
  geom_text(aes(label = paste0(round((count/sum(count))*100), "%")), position = position_stack(vjust = 0.5))
  
}


portfolio_industry <- function(stocks, weigths) {
  port <- as.data.frame(stocks) %>% 
  rename("Symbol" = 1) 
   
  port$weigths <- weigths
  
  port %>% 
  left_join(stock_info, by =  c("Symbol"="Symbol")) %>% 
  group_by(Industry) %>%
  mutate(weigths = round(weigths,2)) %>% 
  filter(weigths > 0.005) %>% 
  summarise(Industry, weigths = sum(weigths)) %>% 
  distinct(Industry, weigths) %>% 
  ggplot(aes(x="", y = weigths, fill = Industry)) +
  geom_bar(stat="identity", width=1, color="white") +
  coord_polar("y", start=0) +
  theme_void() +  
  scale_fill_manual(values = mycolors) +
  
  geom_text(aes(label = paste0((weigths*100), "%")), position = position_stack(vjust = 0.5))
  
}



test$weigths <- opt_sharpe[[2]]

test %>% 
  left_join(stock_info, by =  c("Symbol"="Symbol")) %>% 
  group_by(Industry) %>%
  mutate(weigths = round(weigths,2)) %>% 
  filter(weigths > 0.005) %>% 
  summarise(Industry, weigths = sum(weigths)) %>% 
  distinct(Industry, weigths) %>% 
  ggplot(aes(x="", y = weigths, fill = Industry)) +
  geom_bar(stat="identity", width=1, color="white") +
  coord_polar("y", start=0) +
  theme_void() +  
  scale_fill_manual(values = mycolors) +
  
  geom_text(aes(label = paste0((weigths*100), "%")), position = position_stack(vjust = 0.5))

test

plot_sectors <- function(stocks) {
  industries <- stock_info[stock_info$Symbol %in% stocks,]
  mycolors <- colorRampPalette(brewer.pal(8, "Set2"))(length(stocks))
  
  industries %>% 
  group_by(Sector) %>%
  mutate(count = n()) %>%
  distinct(Sector, count) %>%
  ggplot(aes(x="", y = count, fill = Sector)) +
  geom_bar(stat="identity", width=1, color="white") +
  coord_polar("y", start=0) +
  theme_void() +  
  scale_fill_manual(values = mycolors) +
  
  geom_text(aes(label = paste0(round((count/sum(count))*100), "%")), position = position_stack(vjust = 0.5))
  
}
  
save(stocks_with_industry,file =  "stocks_industry.Rdata")


```


















```{r}
load("stock_df1.Rdata")
load("stock_info.Rdata")
test <- read.csv("companylist.csv")
ny <- read.csv("companylist _ny.csv")
amex <- read.csv("companylist (2).csv")

test_test <- rbind(test,ny,amex)

stock_info <- stock_info %>% 
  select(Symbol, Name)

stock_sector <- test_test %>% 
  select(Symbol, Sector, Industry)


stock_info <- stock_info %>% 
  left_join(stock_sector, by =c("Symbol"="Symbol")) %>% 
   mutate(Industry = na_if(Industry, "n/a")) %>% 
  replace_na(replace = list(Industry ="Unknown")) 

stocks_with_industry <- stock_info %>% 
  filter(Industry != "Unknown") %>% 
  filter(Symbol %in% stocks_symbols)






+a <- test$Symbol


skim(stock_info)


grep("RTX", test_test$Symbol, value = T)

test_test[6392,]

```
